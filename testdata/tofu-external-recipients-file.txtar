env TF_IN_AUTOMATION=true
env TF_INPUT=false
env TF_CLI_ARGS=-no-color

env AGE_RECIPIENTS_FILE=$WORK/recipients.txt
env AGE_IDENTITY_FILE=$WORK/key.txt
exec tofu init

exec tofu apply -auto-approve -lock=false
exec cat terraform.tfstate
! stdout foo
! stdout bar

exec tofu apply -auto-approve -lock=false
exec cat terraform.tfstate
! stdout foo
! stdout bar

-- key.txt --
# created: 2025-09-05T17:27:52-07:00
# public key: age1s2r63x2q98nmv8ppjv5c2zv5xlm4lp0makhmtsumglwhhwnt2e5srs47qt
AGE-SECRET-KEY-1PM25GKMYEWAKGVNM44FPMFXMEEGVDTXUEN3H3LNH2JACJA0UNZPQG00E7N

-- recipients.txt --
# first recipient
age1s2r63x2q98nmv8ppjv5c2zv5xlm4lp0makhmtsumglwhhwnt2e5srs47qt
# end

-- main.tf --
terraform {
  encryption {
    method "external" "age" {
      encrypt_command = ["tofu-age-encryption", "--encrypt"]
      decrypt_command = ["tofu-age-encryption", "--decrypt"]
    }

    state {
      method = method.external.age
      enforced = true
    }

    plan {
      method = method.external.age
      enforced = true
    }
  }
}

output "foo" {
  value = "bar"
}
