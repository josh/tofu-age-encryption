env TF_IN_AUTOMATION=true
env TF_INPUT=false
env TF_CLI_ARGS=-no-color

env TF_VAR_age_identity=file:key.txt

exec tofu init

exec tofu apply -auto-approve -lock=false
exec cat terraform.tfstate
! stdout foo
! stdout bar

exec tofu apply -auto-approve -lock=false
exec cat terraform.tfstate
! stdout foo
! stdout bar

-- key.txt --
# created: 2025-09-05T17:27:52-07:00
# public key: age1s2r63x2q98nmv8ppjv5c2zv5xlm4lp0makhmtsumglwhhwnt2e5srs47qt
AGE-SECRET-KEY-1PM25GKMYEWAKGVNM44FPMFXMEEGVDTXUEN3H3LNH2JACJA0UNZPQG00E7N

-- main.tf --
terraform {
  encryption {
    method "external" "age" {
      encrypt_command = concat(
        ["tofu-age-encryption", "--encrypt"],
        flatten([for recipient in local.age_recipients : ["--recipient", recipient]])
      )
      decrypt_command = ["tofu-age-encryption", "--decrypt", "--identity", nonsensitive(var.age_identity)]
    }

    state {
      method   = method.external.age
      enforced = true
    }

    plan {
      method   = method.external.age
      enforced = true
    }
  }
}

locals {
  age_recipients = [
    "age1s2r63x2q98nmv8ppjv5c2zv5xlm4lp0makhmtsumglwhhwnt2e5srs47qt",
    "age19xls7dzpf24kzfd0vu2vy7w3e4r7cxsxgwgqeccupzswzpktxu6qqqd7vt",
    "age1yh02jaysl73ph50r4xrage2hvstp9hjy72r4p4tlv99zveyf9fvsxc4h9n",
  ]
}

variable "age_identity" {
  type      = string
  sensitive = true
}

output "foo" {
  value = "bar"
}
