env TF_INPUT=false
env TF_CLI_ARGS=-no-color
env AGE_RECIPIENT=age1s2r63x2q98nmv8ppjv5c2zv5xlm4lp0makhmtsumglwhhwnt2e5srs47qt
env AGE_IDENTITY_FILE=$WORK/key-a.txt

exec tofu init

exec tofu apply -auto-approve -lock=false

env AGE_IDENTITY_FILE=$WORK/key-b.txt

! exec tofu apply -auto-approve -lock=false
stderr 'Failed to decrypt payload: age: error: no identity matched any of the recipients'

-- key-a.txt --
# created: 2025-09-05T17:27:52-07:00
# public key: age1s2r63x2q98nmv8ppjv5c2zv5xlm4lp0makhmtsumglwhhwnt2e5srs47qt
AGE-SECRET-KEY-1PM25GKMYEWAKGVNM44FPMFXMEEGVDTXUEN3H3LNH2JACJA0UNZPQG00E7N

-- key-b.txt --
# created: 2025-09-06T01:25:41Z
# public key: age1yh02jaysl73ph50r4xrage2hvstp9hjy72r4p4tlv99zveyf9fvsxc4h9n
AGE-SECRET-KEY-1UTNEY8FW0GN8CXZT8KERWNL9TGDVMQYRT86C6WZQGKTDWTRL7E4Q6CMNMM

-- main.tf --
terraform {
  encryption {
    method "external" "age" {
      encrypt_command = ["tofu-age-encryption", "--encrypt"]
      decrypt_command = ["tofu-age-encryption", "--decrypt"]
    }

    state {
      method = method.external.age
      enforced = true
    }

    plan {
      method = method.external.age
      enforced = true
    }
  }
}

output "foo" {
  value = "bar"
}
